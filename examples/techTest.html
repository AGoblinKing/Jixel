<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta name="viewport" content="width=device-width; initial-scale=1; maximum-scale=1; user-scalable=0;"/>
    <link type="text/css" rel="stylesheet" href="../themes/crispin/jxtheme.css"/>
    <link href='http://fonts.googleapis.com/css?family=Geo' rel='stylesheet' type='text/css'/>
    <script type="text/javascript" src="../lib/mootools-core.js"></script>
    <script type="text/javascript" src="../lib/mootools-more.js"></script>
    <script type="text/javascript" src="../lib/jxlib.js"></script>
    <script type="text/javascript" src="../jixel.js"></script>
    <script type="text/javascript">
    function loaded() {
      
    }
      var game, level, player, cloud, emitter;
      window.addEvent('domready', function(){
        var can = document.createElement('canvas');
        can.getContext('2d')
        game = new Jixel(can);
	game.changeScale(3);
     
        var am = game.am;
        var mapData =
        "0,0,1,1,1,1,1,1,1,1,0,0,0,0,0\n"+
        "2,3,3,3,3,3,3,3,3,3,3,3,3,3,4\n"+
        "5,6,6,6,6,6,6,6,6,6,6,6,6,6,7";
        
        var autoData =
        "0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0\n"+
        "0,0,0,1,0,1,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0\n"+
        "0,0,0,1,0,0,0,1,0,1,0,1,1,1,0,1,0,0,0,0,0,0\n"+
        "0,1,0,1,0,1,0,0,1,0,0,1,1,0,0,1,0,0,0,0,0,0\n"+
        "0,1,1,1,0,1,0,1,0,1,0,1,1,1,0,1,1,0,0,0,0,0\n"+
        "0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0";

        
        var assets = {
                      'cloud':['image', 'assets/cloud.png'],
                      'ship':['image', 'assets/ship.png'],
                      'tiles':['image', 'assets/tilemap.png'],
                      'autotiles': ['image', 'assets/autotiles.png'],
                      'autotiles_alt' : ['image', 'assets/autotiles_alt.png'],
                      'animals':['image', 'assets/animals.png']
                    };
        am.load(assets, function() {
          level = new JxlTileMap(0,112).loadMap(game, mapData, am.get('tiles'));
          
          game.state.add(new JxlTileMap(0,50,JxlTileMap.AUTO).loadMap(game, autoData, am.get('autotiles')));
          game.state.add(new JxlTileMap(0,100,JxlTileMap.ALT).loadMap(game, autoData, am.get('autotiles_alt')));

          level.collideIndex = 2;
          game.state.add(level);
          cloud = new Cloud(am.get('cloud'), 0, 0);
          game.state.add(cloud);
          game.state.add(new Cloud(am.get('cloud'), 400, 40));
	  
         /*
          var shipzor = new Ship(am.get('ship'), 100,100);
          game.add(shipzor);*/
	  var player = new Cat(am.get('animals'), 50, 0);
          game.state.add(player);
          game.follow(player);
          game.start();
          game.showFPS();
          //game.audio.play('keyboard', true, 0, 12.5, .2);
	  $$('body').grab(can);
        }, function() {
          //could add loadBar here
        });
        /*
        $(window).resize(function() {
            game.changeScale(Math.floor($(window).height()/game.height()));
        });
        $(window).resize();*/
      });

      var Cat = new Class({
	Extends: JxlSprite,
	initialize: function(graphic, x, y) {
	  this.parent(graphic, x, y, 32, 32);
	  this.addAnimation('run', [72,73,74,73], .30);
	  this.addAnimation('idle', [48,49,50,49], .50);
	  this.play('idle');
	  this.speed = -80;
	  this.drag = new JxlPoint(150,150);
	  this.acceleration.y = 500;
	},
	update: function(game, time) {
	   if ('A' in game.keys) {
	     this.velocity.x = this.speed;
	     this._flipped = true;
	     this.play('run');
	   } else if ('D' in game.keys) {
	     this._flipped = false;
	     this.play('run');
	     this.velocity.x = -1*this.speed;
	   } else {
	     this.play('idle');
	   }
	   if('SPACE' in game.keys && this.onFloor) {
	     game.audio.play('jump');

	     this.velocity.y = -150;
	   } 
	   
	   this.parent(game, time);
	   
	   jxlU.collide(level, this);
	   jxlU.collide(level, emitter);
	}
      });
      var Ship = new Class({
	Extends: JxlSprite,
	initialize: function(graphic, x, y) {
	  this.parent(graphic, x, y);
	},
	update: function(game, time) {
	  this.angle += 10;
	  this.parent(game, time);
	}
      });
      
      var Cloud = new Class({
	Extends: JxlSprite,
	initialize: function(graphic, x, y) {
	  this.parent(graphic, x, y);
	  this.dir = 1;
	  this.fixed = true;
	  /*
	  this.velocity.x = -1;
	  this.scrollFactor.x = .7;*/
	}
      });
    </script>
    <style type="text/css">
      body {
        background-repeat:repeat;
        background-color:#6ab5f8;
        margin:0px;
        padding:0px;
        overflow:hidden;
        font-family:'Geo';
      }
      .jxDialogControls {
	display:none;
      }
      .ui-widget {
        font-family:'Geo' !important;
      }
      #assets {
        display:none;
      }
    </style>
  </head>
  <body>
    <!--[if lte IE 9]>
    <script type="text/javascript" 
     src="http://ajax.googleapis.com/ajax/libs/chrome-frame/1/CFInstall.min.js"></script>

    <style>

     .chromeFrameInstallDefaultStyle {
       width: 100%; /* default is 800px */
       border: 5px solid blue;
     }
    </style>

    <div id="prompt">
    </div>
 
    <script>
     // The conditional ensures that this code will only execute in IE,
     // Therefore we can use the IE-specific attachEvent without worry
     $(function() {
       CFInstall.check({
         mode: "inline", // the default
         node: "prompt"
       });
     });
    </script>
    <![endif]-->
  </body>
</html>