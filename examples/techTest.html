<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
     <meta name="viewport" content="width=device-width; 
	initial-scale=1; maximum-scale=1; user-scalable=0;"/>
    <link type="text/css" rel="stylesheet" href="../css/ui-lightness/jquery-ui.css"/>
    
    <link href='http://fonts.googleapis.com/css?family=Geo' rel='stylesheet' type='text/css'/>
    
    <script type="text/javascript" src="../js/jquery.js"></script>
    <script type="text/javascript" src="../js/jquery-ui.js"></script>
    <script type="text/javascript" src="../js/mootools-min.js"></script>
    <script type="text/javascript" src="../jixel.js"></script>
    <script type="text/javascript">
      var game, level, player, cloud, emitter;
      $(function(){
        var can = $('<canvas/>')[0];
        can.getContext('2d')
        game = new Jixel(can);
     
        var am = game.am;
        var mapData =
        "0,0,1,1,1,1,1,1,1,1,0,0,0,0,0\n"+
        "2,3,3,3,3,3,3,3,3,3,3,3,3,3,4\n"+
        "5,6,6,6,6,6,6,6,6,6,6,6,6,6,7";
        
        var autoData =
        "0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0\n"+
        "0,0,0,1,0,1,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0\n"+
        "0,0,0,1,0,0,0,1,0,1,0,1,1,1,0,1,0,0,0,0,0,0\n"+
        "0,1,0,1,0,1,0,0,1,0,0,1,1,0,0,1,0,0,0,0,0,0\n"+
        "0,1,1,1,0,1,0,1,0,1,0,1,1,1,0,1,1,0,0,0,0,0\n"+
        "0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0";

        
        var assets = {
                      'cloud':['image', 'assets/cloud.png'],
                      'ship':['image', 'assets/ship.png'],
                      'tiles':['image', 'assets/tilemap.png'],
		      'keyboard':['sound', 'assets/keyboard_cat_remix.mp3'],
                      'autotiles': ['image', 'assets/autotiles.png'],
                      'autotiles_alt' : ['image', 'assets/autotiles_alt.png'],
                      'animals':['image', 'assets/animals.png']
                    };
                     
        game.changeScale(3);
        am.load(assets, function() {
          level = new JxlTileMap(0,112).loadMap(game, mapData, am.get('tiles'));
          
		  emitter = new JxlEmitter(100,0);
		  emitter.setXSpeed(-200, -100);
		  emitter.setYSpeed(-200, 200);
		  emitter.gravity = 500;
		  emitter.s
		  
			var particles = 10;
			var boomDelay = 3;
			 
			for(i = 0; i < particles; i++)
			{
				var particle = new JxlParticle(1);
				particle.createGraphic(4, 4, Math.floor(Math.random() * 0xFFFFFFFF));
				emitter.add(particle);
			}
		 
		  game.state.add(emitter);
          game.state.add(new JxlTileMap(0,50,JxlTileMap.AUTO).loadMap(game, autoData, am.get('autotiles')));
          game.state.add(new JxlTileMap(0,100,JxlTileMap.ALT).loadMap(game, autoData, am.get('autotiles_alt')));

          level.collideIndex = 2;
          game.state.add(level);
          cloud = new Cloud(am.get('cloud'), 0, 0);
          game.state.add(cloud);
          game.state.add(new Cloud(am.get('cloud'), 400, 40));
	  
         /*
          var shipzor = new Ship(am.get('ship'), 100,100);
          game.add(shipzor);*/
	  var player = new Cat(am.get('animals'), 50, 0);
          game.state.add(player);
          game.follow(player);
          game.start();
          game.showFPS();
          game.audio.play('keyboard', true, 0, 12.5, .2);
         $('body').append(can);
        }, function() {
          //could add loadBar here
        });
        /*
        $(window).resize(function() {
            game.changeScale(Math.floor($(window).height()/game.height()));
        });
        $(window).resize();*/
      });

      var Cat = new Class({
	Extends: JxlSprite,
	initialize: function(graphic, x, y) {
	  this.parent(graphic, x, y, 32, 32);
	  this.addAnimation('run', [72,73,74,73], .30);
	  this.addAnimation('idle', [48,49,50,49], .50);
	  this.play('idle');
	  this.speed = -80;
	  this.drag = new JxlPoint(150,150);
	  this.acceleration.y = 500;
	},
	update: function(game, time) {
	   if ('A' in game.keys) {
	     this.velocity.x = this.speed;
	     this._flipped = true;
	     this.play('run');
	   } else if ('D' in game.keys) {
	     this._flipped = false;
	     this.play('run');
	     this.velocity.x = -1*this.speed;
	   } else {
	     this.play('idle');
	   }
	   if('SPACE' in game.keys && this.onFloor) {
		emitter.setXSpeed(-50* ((this._flipped) ? -1 : 1), -10*( (this._flipped) ? -1 : 1));
	     game.audio.play('jump');
		  emitter.at(this);
		  emitter.start(true, 1.2);
	     this.velocity.y = -150;
	   } 
	   
	   this.parent(game, time);
	   
	   jxlU.collide(level, this);
	   jxlU.collide(level, emitter);
	}
      });
      var Ship = new Class({
	Extends: JxlSprite,
	initialize: function(graphic, x, y) {
	  this.parent(graphic, x, y);
	},
	update: function(game, time) {
	  this.angle += 10;
	  this.parent(game, time);
	}
      });
      
      var Cloud = new Class({
	Extends: JxlSprite,
	initialize: function(graphic, x, y) {
	  this.parent(graphic, x, y);
	  this.dir = 1;
	  this.fixed = true;
	  /*
	  this.velocity.x = -1;
	  this.scrollFactor.x = .7;*/
	}
      });
    </script>
    <style type="text/css">
      body {
        background-repeat:repeat;
        background-color:#6ab5f8;
        margin:0px;
        padding:0px;
        overflow:hidden;
        font-family:'Geo';
      }
      .ui-widget {
        font-family:'Geo' !important;
      }
      #assets {
        display:none;
      }
    </style>
  </head>
  <body>
    <!--[if lte IE 9]>
    <script type="text/javascript" 
     src="http://ajax.googleapis.com/ajax/libs/chrome-frame/1/CFInstall.min.js"></script>

    <style>
     .chromeFrameInstallDefaultStyle {
       width: 100%; /* default is 800px */
       border: 5px solid blue;
     }
    </style>

    <div id="prompt">
    </div>
 
    <script>
     // The conditional ensures that this code will only execute in IE,
     // Therefore we can use the IE-specific attachEvent without worry
     $(function() {
       CFInstall.check({
         mode: "inline", // the default
         node: "prompt"
       });
     });
    </script>
    <![endif]-->
  </body>
</html>